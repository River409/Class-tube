<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ClassTube</title>
<style>
body{font-family:Comic Sans MS;background:#f4f4f4;padding:20px;}
input,button,textarea{margin:5px 0;padding:5px;width:100%;}
#feed div, .video-card{background:white;padding:10px;margin-bottom:10px;border-radius:8px;}
video{width:300px;display:block;margin-bottom:5px;}
.avatar{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#777;color:white;margin-right:5px;}
.comment{font-size:14px;border-top:1px solid #eee;padding:2px 0;}
</style>
</head>
<body>

<div id="loginBox">
<h2>Login / Signup</h2>
<input type="text" id="username" placeholder="Username"><br>
<input type="password" id="password" placeholder="Password"><br>
<button id="signupBtn">Sign Up</button>
<button id="loginBtn">Login</button>
<p id="loginStatus" style="color:green;"></p>
</div>

<div id="app" style="display:none;">
<div id="status"></div>
<input type="text" id="videoURL" placeholder="Video URL"><br>
<input type="text" id="videoTitle" placeholder="Video Title"><br>
<button id="uploadBtn">Add Video</button>
<button id="logoutBtn">Logout</button>
<button id="myChannelBtn">My Channel</button>

<h2>Feed</h2>
<div id="feed" style="display:flex; flex-wrap:wrap; gap:16px;"></div>
</div>

<div id="profilePage" style="display:none;">
<h2 id="profileTitle"></h2>
<img id="profileAvatar" style="border-radius:50%; width:64px;">
<button id="backBtn">Back to Feed</button>
<div id="profileVideos" style="display:flex; flex-wrap:wrap; gap:16px; margin-top:8px;"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== REPLACE WITH YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

/* ===== HELPERS ===== */
const $ = id => document.getElementById(id);
function getAvatar(username){ 
  const colors=["#AA47BD","#7B1FA2","#77919D","#455A65","#EC417A","#C1175C","#5D6AC0","#0388D2","#00579B","#0098A7"];
  const color = colors[username.charCodeAt(0)%colors.length];
  return `<div class="avatar" style="background:${color}">${username[0].toUpperCase()}</div>`;
}

/* ===== AUTH HELPERS ===== */
function fakeEmail(username){ return username+"@classtube.com"; }

/* ===== SIGNUP ===== */
async function signup(){
  const username = $("username").value.trim();
  const password = $("password").value.trim();
  if(!username||!password){ $("loginStatus").innerText="Fill all fields"; return; }
  const email = fakeEmail(username);
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    $("loginStatus").innerText = "‚úî Account created!";
  }catch(err){
    $("loginStatus").innerText = err.message;
  }
}

/* ===== LOGIN ===== */
async function login(){
  const username = $("username").value.trim();
  const password = $("password").value.trim();
  if(!username||!password){ $("loginStatus").innerText="Fill all fields"; return; }
  const email = fakeEmail(username);
  try{
    await signInWithEmailAndPassword(auth,email,password);
    $("loginStatus").innerText = "‚úî Logged in!";
  }catch(err){
    $("loginStatus").innerText = "Wrong login!";
  }
}

/* ===== LOGOUT ===== */
function logout(){ signOut(auth); }

/* ===== ADD VIDEO ===== */
async function addVideo(){
  const url = $("videoURL").value.trim();
  const title = $("videoTitle").value.trim() || "Untitled";
  if(!url || !currentUser) return alert("Fill URL & login first");
  await addDoc(collection(db,"videos"),{
    title,
    url,
    user: currentUser,
    timestamp: new Date(),
    likes: [],
    comments: []
  });
  $("videoURL").value="";
  $("videoTitle").value="";
  loadFeed();
}

/* ===== LOAD FEED ===== */
async function loadFeed(){
  const feedEl = $("feed");
  feedEl.innerHTML="";
  const q = query(collection(db,"videos"), orderBy("timestamp","desc"));
  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap=>{
    const v = docSnap.data();
    const id = docSnap.id;
    const card = document.createElement("div");
    card.className="video-card";
    card.innerHTML = `
      <video src="${v.url}" controls></video>
      <div><b>${v.title}</b></div>
      <div>${getAvatar(v.user)}<span style="cursor:pointer;color:#065fd4;" onclick="viewProfile('${v.user}')">${v.user}</span></div>
      <button onclick="toggleLike('${id}')">üëç ${v.likes.length}</button>
      <button id="toggleBtn-${id}" onclick="toggleComments('${id}')">View comments (${v.comments.length})</button>
      <div id="comments-${id}" style="display:none;margin-top:4px;font-size:14px;"></div>
    `;
    feedEl.appendChild(card);
  });
}

/* ===== LIKE ===== */
async function toggleLike(videoId){
  const docRef = doc(db,"videos",videoId);
  const snap = await getDocs(query(collection(db,"videos"),where("__name__","==",videoId)));
  snap.forEach(async d=>{
    const data = d.data();
    const likes = data.likes || [];
    const idx = likes.indexOf(currentUser);
    if(idx>-1){ likes.splice(idx,1); } else { likes.push(currentUser); }
    await updateDoc(d.ref,{likes});
    loadFeed();
  });
}

/* ===== COMMENTS ===== */
async function toggleComments(videoId){
  const box = $("comments-"+videoId);
  const btn = $("toggleBtn-"+videoId);
  const snap = await getDocs(query(collection(db,"videos"),where("__name__","==",videoId)));
  const docData = snap.docs[0].data();
  if(box.style.display==="none"){
    box.style.display="block";
    box.innerHTML="";
    const input = document.createElement("input"); input.placeholder="Add comment";
    const postBtn = document.createElement("button"); postBtn.innerText="Post";
    postBtn.onclick = async ()=>{
      const commentText = input.value.trim();
      if(!commentText) return;
      const comments = docData.comments || [];
      comments.push({user:currentUser,text:commentText});
      await updateDoc(snap.docs[0].ref,{comments});
      loadFeed();
    };
    box.appendChild(input); box.appendChild(postBtn);
    docData.comments.forEach(c=>{
      const cDiv = document.createElement("div");
      cDiv.innerHTML = `<b style="color:#065fd4;cursor:pointer;" onclick="viewProfile('${c.user}')">${c.user}</b>: ${c.text}`;
      box.appendChild(cDiv);
    });
    btn.innerText="Close comments";
  }else{
    box.style.display="none";
    btn.innerText=`View comments (${docData.comments.length})`;
  }
}

/* ===== PROFILE ===== */
async function viewProfile(username){
  $("app").style.display="none";
  $("profilePage").style.display="block";
  $("profileTitle").innerText = username+"'s Channel";
  $("profileAvatar").src = ""; // optional avatar
  $("profileVideos").innerHTML="";
  const q = query(collection(db,"videos"),where("user","==",username),orderBy("timestamp","desc"));
  const snap = await getDocs(q);
  snap.forEach(d=>{
    const v = d.data();
    const vid = document.createElement("video"); vid.src=v.url; vid.controls=true; vid.width=320;
    $("profileVideos").appendChild(vid);
  });
}
function closeProfile(){
  $("profilePage").style.display="none";
  $("app").style.display="block";
}

/* ===== BUTTON EVENTS ===== */
$("signupBtn").onclick=signup;
$("loginBtn").onclick=login;
$("logoutBtn").onclick=logout;
$("uploadBtn").onclick=addVideo;
$("myChannelBtn").onclick=()=>viewProfile(currentUser);
$("backBtn").onclick=closeProfile;

/* ===== AUTH STATE ===== */
onAuthStateChanged(auth,user=>{
  if(user){
    currentUser = user.email.split("@")[0];
    $("loginBox").style.display="none";
    $("app").style.display="block";
    $("status").innerText="Logged in as: "+currentUser;
    loadFeed();
  }else{
    currentUser=null;
    $("loginBox").style.display="block";
    $("app").style.display="none";
  }
});
</script>
</body>
</html>
